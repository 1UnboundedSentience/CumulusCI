<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Cumulus CI by SalesforceFoundation</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header">Cumulus CI</h1>
        <p class="header">Documentation and scripts used in the Continuous Integration process for Project Cumulus</p>

        <ul>
          <li class="download"><a class="buttons" href="https://github.com/SalesforceFoundation/CumulusCI/zipball/master">Download ZIP</a></li>
          <li class="download"><a class="buttons" href="https://github.com/SalesforceFoundation/CumulusCI/tarball/master">Download TAR</a></li>
          <li><a class="buttons github" href="https://github.com/SalesforceFoundation/CumulusCI">View On GitHub</a></li>
        </ul>

        <p class="header">This project is maintained by <a class="header name" href="https://github.com/SalesforceFoundation">SalesforceFoundation</a></p>


      </header>
      <section>
        <h1>
<a name="cumulusci-introduction" class="anchor" href="#cumulusci-introduction"><span class="octicon octicon-link"></span></a>CumulusCI Introduction</h1>

<p><a href="http://ci.salesforcefoundation.org">See it in action</a></p>

<h2>
<a name="contents" class="anchor" href="#contents"><span class="octicon octicon-link"></span></a>Contents</h2>

<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#about-cumulus">About Cumulus</a></li>
<li>
<a href="#repository-workflow">Repository Workflow</a>

<ul>
<li><a href="#merge-vs-rebase">Merge vs Rebase</a></li>
<li><a href="#external-contributions">External Contributions</a></li>
</ul>
</li>
<li><a href="#build-targets">Build Targets</a></li>
<li><a href="#feature-branch-process">Feature Branch Process</a></li>
<li><a href="#dev-branch-process">Dev Branch Process</a></li>
<li><a href="#uat-process">UAT Process</a></li>
<li><a href="#production-release-process">Production Release Process</a></li>
<li><a href="#installation-and-setup">Installation and Setup</a></li>
</ul><h2>
<a name="overview" class="anchor" href="#overview"><span class="octicon octicon-link"></span></a>Overview</h2>

<p><a href="https://raw.github.com/SalesforceFoundation/CumulusCI/master/docs/cumulus_ci_workflow.png"><img src="https://raw.github.com/SalesforceFoundation/CumulusCI/master/docs/cumulus_ci_workflow.png" alt="CumulusCI Workflow"></a></p>

<p>This document provides a high level introduction to the Cumulus Continuous Integration infrastructure (CumulusCI).  CumulusCI is the process used by the Salesforce.com Foundation for the Cumulus project, the next generation of the Non-Profit Starter Pack (NPSP).</p>

<p>The process integrates GitHub, Jenkins, the Salesforce.com Ant Migration Tool, and a custom web application called <a href="http://salesforcefoundation.github.io/mrbelvedere">mrbelvedere</a> running on Heroku.</p>

<p>While this process was specifically built for the Cumulus project, it should be useable by other Force.com projects.</p>

<h2>
<a name="about-cumulus" class="anchor" href="#about-cumulus"><span class="octicon octicon-link"></span></a>About Cumulus</h2>

<p>Project Cumulus is an update and overhaul of the existing Salesforce.com Foundation Nonprofit Starterpack.  More detail about the project is available through the <a href="https://github.com/SalesforceFoundation/Cumulus">Cumulus</a> GitHub repository, however there are some details useful to explaining the CumulusCI process:</p>

<ul>
<li>Cumulus depends on 5 other managed packages each with a large install base.  Feature branches often require new versions of one of the underlying package.</li>
<li>Cumulus will be released as a managed package.</li>
<li>Our team uses a Scrum process where every story has a corresponding issue in GitHub.</li>
<li>We need to address the workflow needs of our internal developers while also creating an open and transparent way for external developers to contribute.</li>
</ul><h2>
<a name="repository-workflow" class="anchor" href="#repository-workflow"><span class="octicon octicon-link"></span></a>Repository Workflow</h2>

<p>The CumulusCI process is a hybrid pulling concepts from GitHub Flow and Git Flow to adapt to the unique build requirements of doing CI on the Force.com platform.</p>

<p>There is only one main, persistent branch in the repository and it is named <code>dev</code> to avoid confusion of whether the ""master"" branch means the current development version or the current production version.  All other branches are created off <code>dev</code> and are designed to be deleted once merged back into dev.</p>

<p>All development work is done in feature branches.  Completed feature branches are merged into the <code>dev</code> branch via a GitHub Pull Request.  No commits should ever be made to the <code>dev</code> branch directly.</p>

<h3>
<a name="merge-vs-rebase" class="anchor" href="#merge-vs-rebase"><span class="octicon octicon-link"></span></a>Merge vs Rebase</h3>

<p>Since the process is based heavily around GitHub Pull Requests which use <code>git merge</code> behind the scenes to perform the merge operation on approved Pull Requests, we have opted for a merge instead of rebase approach.  To ensure that history stays consistent, <code>git rebase</code> should never be used in the Cumulus repository.</p>

<h3>
<a name="external-contributions" class="anchor" href="#external-contributions"><span class="octicon octicon-link"></span></a>External Contributions</h3>

<p>The workflow for the internal team uses a single repository owned by the SalesforceFoundation organization in GitHub.  The process for external contributors is slightly different.  Since external contributors do not have rights to the repository, they cannot create their own feature branches directly in the repository.  They need to first fork the repository in GitHub and then use the same process used by internal developers to build a feature branch.  Once the branch is ready, the external contribution is submitted as a GitHub Pull Request against the <code>dev</code> branch of the SalesforceFoundation/Cumulus repository.</p>

<h2>
<a name="build-targets" class="anchor" href="#build-targets"><span class="octicon octicon-link"></span></a>Build Targets</h2>

<p>Cumulus uses a <a href="https://github.com/SalesforceFoundation/Cumulus/blob/dev/build.xml">build.xml</a> file in the root of the repository to provide a number of useful Ant build targets for working on, deploying, and testing Cumulus.  Even without a deployed Jenkins server, these targets allow anyone to check out the repository and quickly deploy either an unmanaged or managed version of Cumulus to a DE or Partner DE org.</p>

<p>The following build targets are defined in the <a href="https://github.com/SalesforceFoundation/Cumulus/blob/dev/build.xml">build.xml</a> file:</p>

<h3>
<a name="deploy" class="anchor" href="#deploy"><span class="octicon octicon-link"></span></a>deploy</h3>

<p>Runs a simple deployment of the code including execution of all Apex tests as part of the deployment.  If any test failures occur, the deployment is rolled back.</p>

<h3>
<a name="deploywithouttest" class="anchor" href="#deploywithouttest"><span class="octicon octicon-link"></span></a>deployWithoutTest</h3>

<p>Runs a simple deployment of the code but does not execute all Apex tests.  This is useful if you want to quickly deploy already tested code into an org.</p>

<h3>
<a name="deployci" class="anchor" href="#deployci"><span class="octicon octicon-link"></span></a>deployCI</h3>

<p>Runs a complete clean, update, build, test cycle.  Starts with the <a href="#uninstallcumulus">uninstallCumulus</a> target to clean unpackaged metadata from the org.  Then runs <a href="#updatedependentpackages">updateDependentPackages</a> to ensure all managed packages match the required versions for the checked out code.  Finally, runs <a href="#deploy">deploy</a> to deploy the code and run all tests.</p>

<p>NOTE: This is a very destructive operation which is designed to be run against organizations dedicated to CI purposes.  Do not run this against an org </p>

<h3>
<a name="deploymanageduat" class="anchor" href="#deploymanageduat"><span class="octicon octicon-link"></span></a>deployManagedUAT</h3>

<p>Deploys the 5 NPSP managed packages plus the latest beta managed package for Cumulus.</p>

<p>Calls out to the <a href="http://salesforcefoundation.github.io/mrbelvedere">mrbelvedere</a> application to get the latest beta managed package version and its corresponding repository tag.  Sets the required versions per the repository tag's version.properties file and then runs <a href="#updatedependentpackages">updateDependentPackages</a> to do the install/uninstall of managed packages so they are the requested version.  Finally, calls (runAllTests)[#runalltests] to kick off all the Apex tests deployed in the org.</p>

<h3>
<a name="uninstallcumulus" class="anchor" href="#uninstallcumulus"><span class="octicon octicon-link"></span></a>uninstallCumulus</h3>

<p>Uninstalls all unpackaged metadata of types used by Cumulus from a target org.  First, reads all metadata from the org.  Next, builds and deploys a package to reset all ActionOverrides to default on Standard Objects (Account, Contact, Lead, and Opportunity).  Next, builds and deploys a package with a destructiveChanges.xml file to delete all unpackaged metadata which can be deleted.</p>

<h3>
<a name="updatedependentpackages" class="anchor" href="#updatedependentpackages"><span class="octicon octicon-link"></span></a>updateDependentPackages</h3>

<p>Ensures that all 5 original NPSP packages (npe01, npo02, npe03, npe4, and npe5) and the Cumulus managed package (npsp) are installed and at the correct version.  If a package needs to be downgraded, it is first uninstalled.  If a package needs to be upgraded, the upgraded version is installed without first uninstalling the package.</p>

<h3>
<a name="retrieveunpackaged" class="anchor" href="#retrieveunpackaged"><span class="octicon octicon-link"></span></a>retrieveUnpackaged</h3>

<p>Retrieves all unpackaged metadata from the org.  This target is more a utility for developers than a part of the CI process.</p>

<h3>
<a name="runalltests" class="anchor" href="#runalltests"><span class="octicon octicon-link"></span></a>runAllTests</h3>

<p>Uses a blank package to deploy and then run all tests in the target org.  This is useful if the code you want to test is already deployed (i.e. from a managed package) and you just want to kick off the deployed tests.</p>

<h2>
<a name="feature-branch-process" class="anchor" href="#feature-branch-process"><span class="octicon octicon-link"></span></a>Feature Branch Process</h2>

<ul>
<li>
<a href="https://github.com/SalesforceFoundation/CumulusCI/blob/master/docs/jobs/Cumulus_feature.md">Cumulus_feature</a>: Runs a full build against an org dedicated to test feature branches.</li>
<li>
<a href="https://github.com/SalesforceFoundation/CumulusCI/blob/master/docs/jobs/Cumulus_dev_to_feature.md">Cumulus_dev_to_feature</a>: Pushes all changes from the <code>dev</code> branch to all feature branches.  If a merge conflict is encountered, it creates a Pull Request in GitHub to merge dev into the feature branch.  Once the developer manually resolves the merge conflict, the Pull Request is closed automatically.</li>
<li>
<a href="https://github.com/SalesforceFoundation/CumulusCI/blob/master/docs/jobs/Cumulus_check_dependent_versions.md">Cumulus_check_dependent_versions</a>: Checks to make sure the <code>scripts/set_dependent_versions.py</code> script was run after changing the <code>scripts/cumulus.cfg</code> file.</li>
</ul><p>All development work for Cumulus is done in feature branches with a naming convention of `feature/123-description-of-feature' where 123 is the GitHub issue number associated with the branch and description-of-feature is a short description of what the branch contains.</p>

<p>Whenever a new feature branch is pushed to the repository in GitHub or when a push is made against an existing feature branch, the <a href="http://salesforcefoundation.github.io/mrbelvedere">mrbelvedere</a> Heroku app triggers the <a href="https://github.com/SalesforceFoundation/CumulusCI/blob/master/docs/jobs/Cumulus_feature.md">Cumulus_feature</a> job to build the branch and report any build failures to the developer who last committed to the branch.  It also marks build status of the commit via the <a href="https://github.com/blog/1227-commit-status-api">GitHub Commit Status API</a> so any Pull Requests created from the feature branch are marked with their build status as shown in the two examples below:</p>

<p><img src="https://raw.github.com/SalesforceFoundation/CumulusCI/master/docs/github-commit_status_error.png" alt="GitHub Commit Status Failing"></p>

<p><img src="https://raw.github.com/SalesforceFoundation/CumulusCI/master/docs/github-commit_status_pass.png" alt="GitHub Commit Status Passing"></p>

<p>Once a feature branch's Pull Request is approved and merged into the <code>dev</code> branch, the Dev Branch Process starts to test the merged code.</p>

<h3>
<a name="keeping-feature-branches-in-sync-with-dev" class="anchor" href="#keeping-feature-branches-in-sync-with-dev"><span class="octicon octicon-link"></span></a>Keeping feature branches in sync with dev</h3>

<p>One challenge of a feature branch approach is how to keep feature branches in sync with the dev branch.  For example, say I start on a feature branch, feature/1-some-feature.  At the same time, another developer starts the feature/2-another-feature branch.  The other developer completes their branch before I do and submits a Pull Request which is approved and merged into dev.  At this point, my feature/1-some-feature branch is out of sync with dev.</p>

<p>The typical process to handle this example would be for the developer to merge the changes from dev back into their branch.  However, there is not an easy way for them to know this needs to be done.  If dev is not merged into their branch, then a build run on their feature branch does not accurately reflect how their code would function when merged with <code>dev</code>.</p>

<p>To handle this use case, we use the <a href="https://github.com/SalesforceFoundation/CumulusCI/blob/master/docs/jobs/Cumulus_dev_to_feature.md">Cumulus_dev_to_feature</a> job at the end of the Dev Branch Process to push all changes to dev which have passed build back into all open feature branches.  This way, the next time the developer goes to push from their local repository to their feature branch on GitHub, they will be notified that there are new changes they need to pull to their local branch.  This is usually as simple as running <code>git pull</code>.</p>

<h2>
<a name="dev-branch-process" class="anchor" href="#dev-branch-process"><span class="octicon octicon-link"></span></a>Dev Branch Process</h2>

<p>The <code>dev</code> branch is the only persistent branch in the process and should always be passing builds.  We test all feature branches before merge and all feature branches are kept up to date with any changes to the <code>dev</code> branch.</p>

<p>There is a 3 step chain of builds involved in the Dev Branch Process:</p>

<ol>
<li>
<a href="https://github.com/SalesforceFoundation/CumulusCI/blob/master/docs/jobs/Cumulus_dev.md">Cumulus_dev</a>: This job triggers after any commit to the <code>dev</code> branch and uses the deployCI ant target to clean the cumulus.dev org, upgrade any managed package versions which need upgraded, and deploys the <code>dev</code> branch code to the org running all apex tests.  If all tests pass, it then runs the <a href="https://github.com/SalesforceFoundation/CumulusCI/blob/master/docs/jobs/Cumulus_dev_to_feature.md">Cumulus_dev_to_feature</a> job.  If the build fails, all developers are notified.</li>
<li>
<a href="https://github.com/SalesforceFoundation/CumulusCI/blob/master/docs/jobs/Cumulus_dev_cinnamon_deploy.md">Cumulus_dev_cinnamon_deploy</a>: This job deploys the <code>dev</code> branch code to the dedicated org (cumulus.dev.cin) for running Cinnamon browser based tests (Selenium + SauceLabs).  This job only deploys the Cumulus code to the org and does not kick off the Cinnamon tests.  If the build passes, the <a href="https://github.com/SalesforceFoundation/CumulusCI/blob/master/docs/jobs/Cumulus_dev_cinnamon_test.md">Cumulus_dev_cinnamon_test</a> job is run.</li>
<li>
<a href="https://github.com/SalesforceFoundation/CumulusCI/blob/master/docs/jobs/Cumulus_dev_cinnamon_test.md">Cumulus_dev_cinnamon_test</a>: This job deploys the <a href="https://github.com/SalesforceFoundation/CumulusTesting">CumulusTesting</a> repository containing the Cinnamon tests for Cumulus to the cumulus.dev.cin target org and then kicks off the Cinnamon tests.  It parses the test results as a JUnit report so it can show individual test failure trends.</li>
</ol><h2>
<a name="uat-process" class="anchor" href="#uat-process"><span class="octicon octicon-link"></span></a>UAT Process</h2>

<p>The Cumulus team works on a Scrum process with 2 week development iterations.  At the end of each iteration, managed beta package is built for User Acceptance Testing (UAT).  The purpose of the UAT process is to identify issues which prevent the release from going into production.  Changes in functionality which are merely enhancements on the release's functionality should be handled through the normal development process.</p>

<p>The following Jenkins job handle the automation of the UAT Process to the extent currently possible on the Force.com platform.</p>

<ul>
<li><a href="https://github.com/SalesforceFoundation/CumulusCI/blob/master/docs/jobs/Cumulus_uat.md">Cumulus_uat</a></li>
<li><a href="https://github.com/SalesforceFoundation/CumulusCI/blob/master/docs/jobs/Cumulus_uat_cinnamon_deploy.md">Cumulus_uat_cinnamon_deploy</a></li>
<li><a href="https://github.com/SalesforceFoundation/CumulusCI/blob/master/docs/jobs/Cumulus_uat_cinnamon_test.md">Cumulus_uat_cinnamon_test</a></li>
<li><a href="https://github.com/SalesforceFoundation/CumulusCI/blob/master/docs/jobs/Cumulus_uat_managed.md">Cumulus_uat_managed</a></li>
</ul><h3>
<a name="building-a-uat-release" class="anchor" href="#building-a-uat-release"><span class="octicon octicon-link"></span></a>Building a UAT Release</h3>

<p>Creating a UAT release is a 3 step process requiring manual interaction with GitHub and the package org.</p>

<h4>
<a name="step-1-creating-the-release-in-github" class="anchor" href="#step-1-creating-the-release-in-github"><span class="octicon octicon-link"></span></a>Step 1: Creating the release in GitHub</h4>

<p>GitHub has support for managing Releases with a repository.  A release in GitHub is simply a git tag with addional metadata including a markdown enabled body field.</p>

<p>When the <code>dev</code> branch is ready to be rolled over into a UAT release, a Release is created in GitHub by going to the repository, clicking the Releases tab, and clicking the <em>Draft a new release</em> button.</p>

<p>UAT releases should have the <em>This is a pre-release</em> checkbox checked and should use the naming conventions <code>uat/1.0-beta2</code> for the tag name and <code>1.0 (Beta 2)</code> for the release name.  The release name syntax should exactly model the Force.com version number for the managed beta version which will contain it.</p>

<p><img src="https://raw.github.com/SalesforceFoundation/CumulusCI/master/docs/github-creating_a_uat_release.png" alt="Github - Creating a UAT Release"></p>

<p>Once the release is published, <a href="http://salesforcefoundation.github.io/mrbelvedere">mrbelvedere</a> kicks off the <a href="https://github.com/SalesforceFoundation/CumulusCI/blob/master/docs/jobs/Cumulus_uat.md">Cumulus_uat</a> job to deploy the tag's code to the packing org (cumulus.rel) so a beta managed package can be created.</p>

<h4>
<a name="step-2-creating-the-beta-managed-package" class="anchor" href="#step-2-creating-the-beta-managed-package"><span class="octicon octicon-link"></span></a>Step 2: Creating the beta managed package</h4>

<p>Once the <a href="https://github.com/SalesforceFoundation/CumulusCI/blob/master/docs/jobs/Cumulus_uat.md">Cumulus_uat</a> build passes, the code should be deployed to the packaging org.  To create the beta managed package:</p>

<ul>
<li>go to Setup -&gt; Create -&gt; Packages and select the Cumulus package.<br>
</li>
<li>Use the Add Component button to add all the components to the package.</li>
<li>Use the Upload button to create a new Beta Managed Package version.</li>
<li>When you receive the email that the package is available, copy the install url</li>
</ul><h4>
<a name="step-3-add-install-url-to-github-release" class="anchor" href="#step-3-add-install-url-to-github-release"><span class="octicon octicon-link"></span></a>Step 3: Add Install URL to GitHub Release</h4>

<p>Once the beta managed package is ready, we need to update the body of the GitHub release created in Step 1 to include the install URL for the package.  </p>

<p>The <a href="http://salesforcefoundation.github.io/mrbelvedere">mrbelvedere</a> app looks for an installation URL in the body of the Release when searching for the latest beta release.  This is necessary since the Release's tag must be created in the repository, tested, and finally manually packaged before the package can be installed in an org.  Adding the URL to the body of the Release is essentially a way to flag the release as ready.  GitHub Releases have a draft mode but the draft mode does not create a tag in the repository until it is published and thus does not solve this issue.</p>

<h3>
<a name="testing-the-uat-release" class="anchor" href="#testing-the-uat-release"><span class="octicon octicon-link"></span></a>Testing the UAT Release</h3>

<p>The <a href="https://github.com/SalesforceFoundation/CumulusCI/blob/master/docs/jobs/Cumulus_uat_managed.md">Cumulus_uat_managed</a> job in Jenkins monitors the <a href="http://salesforcefoundation.github.io/mrbelvedere">mrbelvedere</a> app for a change in the latest managed beta package version.  When a change is detected, a build is triggered to deploy the managed package to the cumulus.uat org and then kick off all tests in the org.</p>

<h2>
<a name="production-release-process" class="anchor" href="#production-release-process"><span class="octicon octicon-link"></span></a>Production Release Process</h2>

<p><a href="https://github.com/SalesforceFoundation/CumulusCI/blob/master/docs/jobs/Cumulus_rel.md">Cumulus_rel</a></p>

<p>More on the Release Process coming soon...</p>

<h2>
<a name="installation-and-setup" class="anchor" href="#installation-and-setup"><span class="octicon octicon-link"></span></a>Installation and Setup</h2>

<p>The <a href="https://github.com/SalesforceFoundation/CumulusCI/blob/master/docs/setup/README.md">Installation and Setup</a> documentation provides details on building out a server with Jenkins and the necessary plugins and configuration needed to run the jobs for CumulusCI.</p>
      </section>
      <footer>
        <p><small>Hosted on <a href="http://pages.github.com">GitHub Pages</a> using the Dinky theme</small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
		
  </body>
</html>
